<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SovereignSearch</title>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
  const savedTheme = localStorage.getItem('appTheme') || 'system';
  document.documentElement.dataset.theme = savedTheme;
</script>

<script>
  window.addEventListener('storage', (e) => {
    if (e.key === 'appTheme') {
      document.documentElement.dataset.theme = e.newValue || 'system';
    }
  });
</script>


<!-- Use merged app CSS -->
<link rel="stylesheet" href="style.css">

</head>

<body>

<div id="searchPage">

  <h2>Search</h2>

  <input
    id="searchBox"
    type="text"
    placeholder="Search SCID, dURL, name or description..."
    disabled
  />

  <div id="status">Fetching indexed SCIDs...</div>
  <div id="results"></div>

</div>

<script>
const apiBase = "http://127.0.0.1:8099/api";

let allResults = [];
let fuse;
const loadedSCIDs = new Set();

// Fetch all indexed SCIDs
async function fetchAllSCIDs() {
  const resp = await fetch(`${apiBase}/indexedscs`);
  if (!resp.ok) throw new Error("Failed to fetch indexed SCIDs");
  const data = await resp.json();
  return Object.keys(data.indexedscs || {});
}

// Fetch SCID variables
async function fetchSCIDData(scid) {
  try {
    const resp = await fetch(`${apiBase}/scvarsbyheight?scid=${scid}`);
    if (!resp.ok) return null;

    const data = await resp.json();
    if (!data.variables) return null;

    let dURL = "";
    let nameHdr = "";
    let descrHdr = "";

    data.variables.forEach(v => {
      if (v.Key === "dURL") dURL = v.Value;
      if (v.Key === "nameHdr") nameHdr = v.Value;
      if (v.Key === "descrHdr") descrHdr = v.Value;
    });

    if (!dURL) return null;

    return { scid, dURL, nameHdr, descrHdr };
  } catch {
    return null;
  }
}

// Render results
function renderResults(results) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  results.forEach(r => {
    const div = document.createElement("div");
    div.className = "result";

    div.innerHTML = `
      <div class="url">${r.dURL}</div>

      <div class="nameHdr" onclick="handleSCIDClick('${r.scid}')" style="cursor:pointer;">
      ${r.nameHdr}
      </div>

      <div class="scid" onclick="handleSCIDClick('${r.scid}')">
        ${r.scid}
      </div>

      <div class="descr">${r.descrHdr}</div>
    `;

    container.appendChild(div);
  });
}

// CLICK HANDLER â€” this is the only integration point
function handleSCIDClick(scid) {
  if (!window.electronAPI?.selectSCID) {
    console.warn("selectSCID not available");
    return;
  }

  window.electronAPI.selectSCID(scid);
}

// Fuzzy filtering
function filterResults(query) {
  if (!query.trim()) {
    renderResults(allResults);
    return;
  }

  const results = fuse.search(query);
  renderResults(results.map(r => r.item));
}

// Load everything once
async function loadSCIDs() {
  const status = document.getElementById("status");
  const searchBox = document.getElementById("searchBox");

  const scids = await fetchAllSCIDs();
  status.textContent = `Scanning ${scids.length} SCIDs...`;

  for (const scid of scids) {
    const res = await fetchSCIDData(scid);
    if (res) allResults.push(res);
  }

  status.textContent = `Loaded ${allResults.length} SCIDs with dURL`;
  searchBox.disabled = false;

  fuse = new Fuse(allResults, {
    keys: [
      { name: "scid", weight: 2 },
      { name: "dURL", weight: 1.5 },
      { name: "nameHdr", weight: 1 },
      { name: "descrHdr", weight: 0.8 }
    ],
    threshold: 0.25,
    ignoreLocation: true,
    minMatchCharLength: 2
  });

  renderResults(allResults);
}

document.getElementById("searchBox").addEventListener("input", e => {
  filterResults(e.target.value);
});

// Live update handler
if (window.electronAPI?.onGnomonLog) {
  window.electronAPI.onGnomonLog(async (line) => {
    const match = line.match(/scid:\s*([a-z0-9]+)/i);
    if (!match) return;

    const scid = match[1];
    if (loadedSCIDs.has(scid)) return;
    loadedSCIDs.add(scid);

    const res = await fetchSCIDData(scid);
    if (!res) return;

    allResults.push(res);
    fuse.setCollection(allResults);
    renderResults(allResults);
    document.getElementById("status").textContent = `Loaded ${allResults.length} SCIDs (live update)`;
  });
}

loadSCIDs();

</script>

</body>
</html>
